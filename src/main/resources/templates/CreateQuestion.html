<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ask a Public Question</title>

    <link rel="stylesheet" th:href="@{/css/createquestion.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <style>
        /* Custom styles to ensure white background */
        .ql-syntax {
          background-color: gray !important;
          color: black !important;
        }
    </style>
<!--    <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>-->
<!--    <script>-->
<!--        ClassicEditor-->
<!--            .create(document.querySelector('#description'))-->
<!--            .catch(error => {-->
<!--                console.error(error);-->
<!--            });-->

<!--         function insertCodeSnippet() {-->
<!--        const textarea = document.getElementById("description");-->
<!--        const snippet = `<pre><code class="language-java">\n// insert code here\n</code></pre>\n`;-->

<!--        // Insert at current cursor position-->
<!--        const start = textarea.selectionStart;-->
<!--        const end = textarea.selectionEnd;-->
<!--        const text = textarea.value;-->

<!--        textarea.value = text.substring(0, start) + snippet + text.substring(end);-->

<!--        // Move cursor after inserted snippet-->
<!--        textarea.selectionStart = textarea.selectionEnd = start + snippet.length;-->
<!--        textarea.focus();-->
<!--    }-->
<!--    </script>-->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <style>
        .content-wrapper{
            flex:1;
            display:grid;
            grid-template-columns: 1fr 300px;
            gap:32px;
            padding:40px 64px;
            background:#f1f2f3;
        }

        .question-column{
            background:#fff;border-radius:8px;
            padding:30px 40px;box-shadow:0 2px 10px rgba(0,0,0,.05);
            display:flex;flex-direction:column;gap:24px;
        }

        .help-column{
            background:#f8f9f9;border:1px solid #e4e6e8;
            border-radius:6px;padding:24px;height:max-content;
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/header :: header(user=${user})}"></div>

<!-- ======= sidebar + main area ======= -->
<div class="layout">
    <div th:replace="fragments/Sidebar :: Sidebar"></div>

    <main class="content-wrapper">

        <!-- ========== MAIN QUESTION FORM ========== -->
        <section class="question-column">

            <h1>Ask a public question</h1>

            <form id="qForm" th:action="@{/create-question}" th:object="${question}" method="post">
                <!-- TITLE --------------------------------------------------- -->
                <div th:classappend="${#fields.hasErrors('title')} ? 'has-error'" class="question-fields">
                    <label for="title">Title*</label>
                    <div class="subtext">Be specific and imagine you’re asking a question to another person</div>
                    <input id="title" type="text" th:field="*{title}" placeholder="e.g. How do I find the index of an element in a list?"/>
                    <p class="error-msg" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></p>
                </div>

                <!-- DESCRIPTION -------------------------------------------- -->
                <div th:classappend="${#fields.hasErrors('description')} ? 'has-error'" class="question-fields">
                    <label for="description">Description*</label>
                    <div class="subtext">Include all the information someone would need to answer your question</div>
<!--                    <button type="button" onclick="insertCodeSnippet()">Insert Code Snippet</button>-->
<!--                    <textarea id="description" name="description" th:field="*{description}"></textarea>-->
                    <input type="hidden" id="description"  th:field="*{description}"></input>
                    <!-- Quill editor container -->
                    <div id="editor-container" style="height: 300px;"></div>

                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                          // Initialize Quill editor
                          var quill = new Quill('#editor-container', {
                            theme: 'snow',
                            placeholder: 'Write your answer here...',
                            modules: {
                              toolbar: [
                                ['bold', 'italic', 'underline'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                ['code-block'],
                                ['link']
                              ]
                            }
                          });

                          // Function to ensure <code> is wrapped inside <pre> and apply highlighting
                          function highlightCodeBlocks() {
                            // Select all <pre> elements with code
                            var codeBlocks = quill.root.querySelectorAll('pre');

                            codeBlocks.forEach(function(block) {
                              var code = block.querySelector('code');

                              if (!code) {
                                // If no <code> tag is found, wrap the content in a <code> tag
                                code = document.createElement('code');
                                code.innerHTML = block.innerHTML;
                                block.innerHTML = '';  // Clear the content
                                block.appendChild(code);
                              }

                              // Add language class for Java (this can be dynamic based on language)
                              code.classList.add('language-java');

                              // Highlight the code with highlight.js
                              hljs.highlightElement(code);
                            });
                          }

                          // Highlight code blocks when content is loaded into Quill or updated
                          quill.on('text-change', function() {
                            highlightCodeBlocks();
                          });

                          // On form submit, copy HTML content to hidden input
                          document.querySelector('#qForm').addEventListener('submit', function () {
                            var description = quill.root.innerHTML; // Get HTML content
                            document.getElementById('description').value = description; // Set it to the hidden input
                          });

                          // Apply highlighting when the page initially loads
                          highlightCodeBlocks();
                        });
                    </script>

                    <p class="error-msg" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></p>
                </div>

                <div class="question-fields">
                <label for="tagInput">Tags*</label>
                <div class="subtext">Type to search or add (max&nbsp;5)</div>

                <div id="tagBox" class="tag-box">
                    <input id="tagInput" autocomplete="off" placeholder="start typing…">
                </div>

                <ul id="tagMenu" class="tag-menu hidden">
                    <li th:each="t : ${allTags}" th:text="${t}" class="item">java</li>
                </ul>

                <input type="hidden" id="tagsHidden" name="tags">
                <p class="error-msg" th:if="${tagsError}" th:text="${tagsError}"></p>
                <p th:field="${tags}"></p>
                </div>
                <button class="ask-btn" type="submit">Submit your question</button>
            </form>
        </section>

        <aside class="help-column">
            <div class="help-box">
                <h2>Step&nbsp;1: Draft your question</h2>
                <p>The community is here to help you with specific coding, algorithm, or language problems.</p>
                <p><strong>Avoid asking opinion-based questions.</strong></p>

                <details class="help-step">
                    <summary>1. Summarize the problem</summary>
                    <div class="step-content">
                        Explain what you're trying to do and what you expected to happen.
                    </div>
                </details>

                <details class="help-step">
                    <summary>2. Describe what you’ve tried</summary>
                    <div class="step-content">
                        Share the research or steps you've taken so far.
                    </div>
                </details>

                <details class="help-step">
                    <summary>3. Show some code</summary>
                    <div class="step-content">
                        Add relevant code snippets to illustrate your issue.
                    </div>
                </details>
            </div>
        </aside>

    </main>
</div>
<script th:inline="javascript">
    (() => {
        const MAX = 5;

        const box    = document.getElementById('tagBox');
        const input  = document.getElementById('tagInput');
        const menu   = document.getElementById('tagMenu');
        const items  = Array.from(menu.querySelectorAll('.item'));
        const hidden = document.getElementById('tagsHidden');

        let selected = [];

        const syncHidden = () => hidden.value = selected.join(',');

        const addChip = tag => {
            const chip = document.createElement('span');
            chip.className = 'tag-chip';
            chip.textContent = tag;

            const x = document.createElement('span');
            x.className = 'x';
            x.textContent = '×';
            x.onclick = () => remove(tag);

            chip.appendChild(x);
            box.insertBefore(chip, input);
        };

        const render = () => {
            box.querySelectorAll('.tag-chip').forEach(c => c.remove());
            selected.forEach(addChip);
            syncHidden();
        };

        const add = tag => {
            tag = tag.trim().toLowerCase();
            const isValid = /^[a-z0-9-]{2,25}$/.test(tag); // alphanumeric & dashes, 2-25 chars
            if (tag && isValid && !selected.includes(tag) && selected.length < MAX) {
                selected.push(tag);
                render();
            }
        };

        const remove = tag => {
            selected = selected.filter(t => t !== tag);
            render();
        };

        const filter = query => {
            let first = null;
            items.forEach(li => {
                const show = li.textContent.includes(query) && !selected.includes(li.textContent);
                li.style.display = show ? 'block' : 'none';
                li.classList.remove('active');
                if (show && !first) first = li;
            });
            first?.classList.add('active');
            menu.classList.toggle('hidden', !query && !first);
        };

        input.addEventListener('input', () => filter(input.value.toLowerCase()));

        input.addEventListener('keydown', e => {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                add(input.value);
                input.value = '';
                filter('');
            }
            if (e.key === 'ArrowDown') {
                menu.querySelector('.active')?.focus();
            }
        });

        items.forEach(li => li.addEventListener('mousedown', () => {
            add(li.textContent);
            input.value = '';
            filter('');
        }));

        document.addEventListener('click', e => {
            if (!box.contains(e.target) && !menu.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });
    })();
</script>
</body>
</html>
